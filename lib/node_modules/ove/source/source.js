var scope = exports.scope = {};
var hljs = require('highlight.js');

var regularizeSourceHTML = function(piece){
	piece = (piece + "\n").replace(/\u001b/g, '\u001bE');
	var oPiece, k = 0;
	do {
		oPiece = piece;
		piece = oPiece.replace(/(<(\w+).*?>)([^<>]*?)(<\/\2>)/g, function(piece, left, tag, body, right){
			body = left + body.replace(/\n[ \t]*/g, function(m){return right + m + left}) + right;
			return body.replace(/</g, '\u001bL').replace(/>/g, '\u001bR');
		});
		k++;
	} while(k < 10 && oPiece != piece);
	var t = this;
	piece = piece
	             .replace(/^([ \t]*)(\S.*)\n/gm, function(m, $1, $2){
	             	return '<b indent="' + (t.detab($1).length) + '"><i>' + $1 + '</i>' + $2 + '<i>\n</i></b>'
	             })
	             .replace(/\u001bL/g, '<')
	             .replace(/\u001bR/g, '>')
	             .replace(/\u001bE/g, '\x1B')
	             .replace(/\u001b/g, '');
	return piece;
}
scope.sourceAfter = function(language, piece){
	return this['<']('pre', 'class="mghl source ' + language + '"', regularizeSourceHTML.call(this, piece));
}
scope.source = function(language, text){
	return this.sourceAfter(language, hljs.highlight(language, text.trimRight()).value);
}
scope.useLanguage = function(language, alias){
	this[language] = this['source-' + language] = function(s){return this.source(language, s)}
	if(alias){this[alias] = this['source-' + alias] = this[language]};
	return '';
}

exports.apply = function(){
	this.usePackage('ove/html');
	this.__merge(scope);
	require('./source.ed').apply.call(this);
}